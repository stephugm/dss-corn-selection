{% extends "base.html" %}

{% block title %}Results{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Project Info -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ project.title }}</h1>
                <div class="flex items-center space-x-2">
                    {% if project.method == 'ahp' %}
                    <span class="px-2.5 py-0.5 bg-blue-100 text-blue-800 rounded-full text-sm">AHP</span>
                    <p class="text-sm text-gray-600">Analytic Hierarchy Process</p>
                    {% elif project.method == 'topsis' %}
                    <span class="px-2.5 py-0.5 bg-purple-100 text-purple-800 rounded-full text-sm">TOPSIS</span>
                    <p class="text-sm text-gray-600">Technique for Order of Preference by Similarity to Ideal Solution</p>
                    {% else %}
                    <span class="px-2.5 py-0.5 bg-green-100 text-green-800 rounded-full text-sm">Profile Matching</span>
                    <p class="text-sm text-gray-600">Profile Matching</p>
                    {% endif %}
                </div>
            </div>
            <a href="{{ url_for('export_results_pdf', project_id=project.project_id) }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Export Results
            </a>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Recommended Alternative</h2>
        <p class="text-gray-700">
            Based on the analysis, the recommended alternative is
            <span class="font-semibold text-green-700">{{ results[0]['alternative'] }}</span>
            with a final score of
            <span class="font-semibold text-green-700">{{ "%.4f"|format(results[0]['final_score']) }}</span>.
        </p>
    </div>

    <!-- Results Grid -->
    <div class="grid grid-cols-1 {% if project.method != 'profile_matching' %}lg:grid-cols-2{% endif %} gap-6">
        <!-- Rankings Chart -->
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Alternative Rankings</h2>
            <div class="h-64">
                <canvas id="rankingsChart"></canvas>
            </div> 
        </div>

        {% if project.method != 'profile_matching' %}
        <!-- Criteria Weights -->
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Criteria Weights</h2>
            <div class="h-64">
                <canvas id="weightsChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Detailed Scores Table -->
        <div class="bg-white rounded-lg shadow-sm border p-6 lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Detailed Scores</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alternative</th>
                            {% for criterion in criteria %}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ criterion }}</th>
                            {% endfor %}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {% if project.method == 'ahp' %}Priority{% else %}Score{% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for alt in alternatives %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{{ results[loop.index0].rank }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ alt }}
                                {% if results[loop.index0].rank == 1 %}
                                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    âœ… Recommended
                                </span>
                                {% endif %}
                            </td>
                            {% for criterion in criteria %}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ scores[alt][criterion] }}</td>
                            {% endfor %}
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">
                                {{ "%.4f"|format(results[loop.index0].final_score) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get data from template
    const templateData = {
        method: '{{ project.method }}',
        alternatives: {
            names: JSON.parse('{{ alternatives|list|tojson|safe }}'),
            scores: JSON.parse('{{ results|map(attribute="final_score")|list|tojson|safe }}'),
            ranks: JSON.parse('{{ results|map(attribute="rank")|list|tojson|safe }}')
        },
        criteria: {
            names: JSON.parse('{{ criteria|list|tojson|safe }}')
        }
    };
    
    // Add weights only if not profile matching
    {% if project.method != 'profile_matching' %}
    templateData.criteria.weights = JSON.parse('{{ weights.values()|list|tojson|safe }}');
    {% endif %}
    
    // Check method types
    const isAHP = templateData.method === 'ahp';
    const isProfileMatching = templateData.method === 'profile_matching';

    // Prepare data for charts
    const method = '{{ project.method }}';
    
    // Sort alternatives by rank
    const sortedAlternatives = templateData.alternatives.names
        .map((name, i) => ({
            name,
            score: templateData.alternatives.scores[i],
            rank: templateData.alternatives.ranks[i]
        }))
        .sort((a, b) => a.rank - b.rank);
    
    // Take top 5 or all if less than 5
    const topN = Math.min(5, sortedAlternatives.length);
    const topAlternatives = sortedAlternatives.slice(0, topN);
    
    // Rankings Chart
    const rankingsCtx = document.getElementById('rankingsChart').getContext('2d');
    new Chart(rankingsCtx, {
        type: 'bar',
        data: {
            labels: topAlternatives.map(a => a.name),
            datasets: [{
                label: 'Score',
                data: topAlternatives.map(a => a.score),
                backgroundColor: topAlternatives.map(a => 
                    a.rank === 1 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(59, 130, 246, 0.8)'
                ),
                borderColor: topAlternatives.map(a =>
                    a.rank === 1 ? 'rgb(21, 128, 61)' : 'rgb(29, 78, 216)'
                ),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Score'
                    },
                    max: templateData.method === 'ahp' ? 1 : undefined
                },
                x: {
                    title: {
                        display: true,
                        text: 'Alternatives'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            return value ? value.toFixed(4) : '0.0000';
                        }
                    }
                }
            }
        }
    });

    // Initialize weights chart if not profile matching and element exists
    if (!isProfileMatching && templateData.criteria.weights) {
        const weightsCanvas = document.getElementById('weightsChart');
        if (weightsCanvas) {
            const weightsCtx = weightsCanvas.getContext('2d');
            
            // Prepare criteria data with weights
            const criteriaWithWeights = templateData.criteria.names.map((name, index) => ({
                name: name,
                weight: templateData.criteria.weights ? templateData.criteria.weights[index] : 0
            })).sort((a, b) => b.weight - a.weight);
            
            new Chart(weightsCtx, {
                type: 'doughnut',
                data: {
                    labels: criteriaWithWeights.map(c => c.name),
                    datasets: [{
                        data: criteriaWithWeights.map(c => c.weight),
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.7)',
                            'rgba(99, 102, 241, 0.7)',
                            'rgba(129, 140, 248, 0.7)',
                            'rgba(165, 180, 252, 0.7)',
                            'rgba(199, 210, 254, 0.7)',
                            'rgba(224, 231, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(79, 70, 229, 1)',
                            'rgba(99, 102, 241, 1)',
                            'rgba(129, 140, 248, 1)',
                            'rgba(165, 180, 252, 1)',
                            'rgba(199, 210, 254, 1)',
                            'rgba(224, 231, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${(value * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
